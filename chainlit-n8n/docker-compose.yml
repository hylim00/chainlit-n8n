services:
  postgres:
    image: postgres:15
    container_name: pg_rag
    environment:
      POSTGRES_PASSWORD: rag123
      POSTGRES_DB: ragdb
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    environment:
      # Zona waktu
      - TZ=Asia/Jakarta
      - GENERIC_TIMEZONE=Asia/Jakarta

      # Auth UI (opsional, sementara dimatikan)
      - N8N_BASIC_AUTH_ACTIVE=false

      # Database (Postgres)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pg_rag
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=ragdb
      - DB_POSTGRESDB_USER=postgres
      - DB_POSTGRESDB_PASSWORD=rag123

      # Konfigurasi host & webhook (akses langsung via localhost:5678)
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/

      # Binary data → sesuai docs: N8N_DEFAULT_BINARY_DATA_MODE
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_BINARY_DATA_STORAGE_PATH=/data/binary

    volumes:
      # Data utama n8n (wajib)
      - ./n8n_data:/home/node/.n8n
      # Lokasi penyimpanan binary di disk
      - ./binary_data:/data/binary
      # (Opsional) tmp ter‑mount, boleh dipertahankan
      - ./tmp_n8n:/tmp

    depends_on:
      - postgres
    restart: unless-stopped

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    depends_on:
      - n8n
    command: >
      http n8n:5678 --log=stdout --log-format=logfmt
    environment:
      - NGROK_AUTHTOKEN=YOUR_NGROK_TOKEN
    restart: unless-stopped